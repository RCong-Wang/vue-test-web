"use strict";(self["webpackChunkmy_vue_app"]=self["webpackChunkmy_vue_app"]||[]).push([[985],{5985:function(e,s,t){t.r(s),t.d(s,{default:function(){return w}});var n=t(3396),o=t(7139),a=t(9242);const i={class:"chat-window"},l={class:"message-container",ref:"messageContainer"},c={style:{"font-size":"12px"}},r=(0,n._)("br",null,null,-1),d={style:{"border-style":"dashed"}},h={class:"input-container"};function g(e,s,t,g,u,m){return(0,n.wg)(),(0,n.iD)(n.HY,null,[(0,n._)("div",null,[(0,n._)("h1",null,"聊天室:"+(0,o.zw)(this.roomID),1)]),(0,n._)("div",i,[(0,n._)("div",l,[(0,n._)("ul",null,[((0,n.wg)(!0),(0,n.iD)(n.HY,null,(0,n.Ko)(u.messages,(e=>((0,n.wg)(),(0,n.iD)("li",null,[(0,n._)("p",null,[(0,n._)("span",c,(0,o.zw)(e.time),1),r,(0,n._)("span",d,(0,o.zw)(e.senter)+": "+(0,o.zw)(e.context),1)])])))),256))])],512)]),(0,n._)("div",h,[(0,n.wy)((0,n._)("input",{type:"text",id:"send-message-box","onUpdate:modelValue":s[0]||(s[0]=e=>u.sendmessage=e),onKeyup:s[1]||(s[1]=(0,a.D2)(((...e)=>m.SendMessage&&m.SendMessage(...e)),["enter"]))},null,544),[[a.nr,u.sendmessage]]),(0,n._)("button",{onClick:s[2]||(s[2]=(...e)=>m.SendMessage&&m.SendMessage(...e))},"發送訊息")])],64)}var u={name:"Chatroom",computed:{roomID(){return this.$store.getters.getroomid}},data(){return{websocket:null,messages:[],sendmessage:""}},beforeUnmount(){window.removeEventListener("beforeunload",this.closeWebSocket)},created(){this.axios=(0,n.f3)("axios"),this.GetMessage(),this.websocket=new WebSocket(`${this.local_ws}/ws/chat/${this.roomID}/`),this.websocket.onopen=e=>{console.log("successful link: ",e)},window.addEventListener("beforeunload",this.closeWebSocket)},mounted(){this.websocket.onmessage=e=>{const s=JSON.parse(e.data).message;this.messages.unshift(s)}},methods:{GetMessage(){this.axios.get(`${this.local_http}/main/getmessage/`,{params:{id:this.roomID}}).then((e=>{e.data.fail?console.log(e.data):this.messages=e.data})).catch((e=>{console.error("獲得訊息失敗",e)}))},SendMessage(){""==this.sendmessage?console.log("發送失敗: 訊息欄為空"):this.axios.get(`${this.local_http}/user/getcsrf/`).then((e=>{const s=e.data.csrf_token,t={messages:this.sendmessage,id:this.roomID};this.axios.post(`${this.local_http}/main/sendmessage/`,t,{withCredentials:!0,headers:{"X-CSRFToken":s,"Content-Type":"application/json"}}).then((e=>{console.log("發送成功",e.data);const s={message:e.data.id};this.websocket.send(JSON.stringify(s)),this.sendmessage=""})).catch((e=>{console.error("發送失敗",e)}))}))},closeWebSocket(){this.websocket.close()}}},m=t(89);const p=(0,m.Z)(u,[["render",g]]);var w=p}}]);
//# sourceMappingURL=985.39955025.js.map